# 레지스터, 스택 & 힙, 동적 메모리, 다중 포인터

이 문서는 Pope Kim [C 언매니지드 프로그래밍](https://www.udemy.com/course/c-unmanaged-programming-by-pocu/) 강의를 듣고 정리한 문서입니다.

## 메모리의 종류

- 프로그램에서 주로 사용하는 부품은 2개이다.
  - CPU
    - 모든 코드의 로직(연산)을 실행하는 제어 장치.
  - 메모리
    - 실행 중인 코드 및 연산의 중간 결과 등을 저장하는 공간.
    - 변수나 배열 등에 대입되는 데이터가 저장된다.
- 메모리는 또 다시 나뉜다. 개발자가 신경써야 하는 수준에서 나누어보자.
  - 스택(stack) 메모리
    - 스택은 특별한 용도(쓰레드)에 사용하라고 별도로 떼어놔 준 것이다.
  - 힙(heap) 메모리
    - 기본은 힙 메모리이다. 힙 메모리는 누구라도 자기 마음대로, 어디에도 사용할 수 있는 메모리이다.
  - 사실 이 둘은 물리적으로는 같은 메모리이다.
- CPU 안에도 저장 공간이 있다.
  - 레지스터: CPU에서만 사용할 수 있는 고속 저장 공간이다.
  - 엄밀히 말하면 메모리는 아니다.

## 스택 메모리

- 함수를 호출할 때 스택에 정확히 어떤 게 어떤 순서로 들어가는지는 함수 호출 규악(calling conveition)에 따라 달라진다. <https://en.wikipedia.org/wiki/Calling_convention>

## 레지스터

- 엄밀한 의미의 메모리는 아니다. 그치만 휘발성으로 데이터를 저장하는 공간이긴 하다.
- 메모리를 읽고 쓰는 게 느린 이유
  - CPU가 메모리에 접근할 때마다 버스를 거쳐야 한다. 즉, CPU가 연산할 때마다 메모리에 접근하는 시간이 발생한다.
  - 대부분의 컴퓨터에 장착하는 메모리는 DRAM(Dynamic Random Access Memory)이다. DRAM은 가격이 저렴하지만 큰 단점이 있다. 기록된 내용을 유지하기 위해서 주기적으로 정보를 다시 써야 한다는 것이다. 빨라지기가 어려운 단점이 있다.
- 그래서...메모리를 읽고 쓰는 건 느리다. 그래서 CPU 전용의 저장 공간을 만들자는 아이디어가 나왔다. 이게 레지스터이다. SRAM을 CPU안에 넣어두는 식이다.
- 레지스터는 CPU가 사용하는 저장 공간 중에 가장 빠른 저장 공간이다.
- CPU가 연산을 할 때 보통 레지스터에 저장되어 있는 데이터를 사용하고 연산 결과도 레지스터에 다시 저장하는 게 보통이다.

## register 키워드

- C에서는 레지스터를 어떻게 사용할까?
  - 레지스터를 사용해달라고 요청은 할 수 있다. 그치만 실제로 그렇게 될지는 컴파일러에 따라 다르다. 따라서 레지스터를 사용해 달라는 '힌트'정도를 주는 의미이다.

  ```c
  int num;
  register size_t i;

  num = 0;

  for (i = 0; i < 1000; ++i)
  {
      num += i;
  }
  printf("num: %d\n", num);

  ```

- register 키워드
  - `register <자료형> <변수명>`
  - 저장 유형 지정자 (storage-class specifier)
  - 가능하다면 해당 변수를 레지스터에 저장할 것을 요청한다. 그러나 실제로 레지스터를 사용할지 말지는 컴파일러가 결정한다.
  - 레지스터는 메모리가 아니다. 따라서 몇 가지 제약 사항이 있다.
    - 변수의 주소를 구할 수 없다.
    - 레지스터 배열을 포인터로 사용 불가.
    - 블록 범위에서만 사용 가능하다. 전역 변수로는 사용할 수 없다.

- 예전 임베디드 시스템에서는 의미가 있었지만, 현재 데스크탑 환경에서는 대부분 의미가 없다. 또한, 요즘은 굳이 register 키워드를 쓰지 않더라도 컴파일러가 잘 최적화를 해준다. 따라서 굳이 프로그래머가 수동으로 사용하지 않는 키워드이다.

## 힙 메모리

- 스택 메모리의 단점
  - 수명
    - 함수가 반환하면 그 안에 있던 데이터가 다 날아간다. 따라서 데이터를 오래 보존하려면 전역 변수 또는 static 키워드를 사용해야 했다.
  - 크기
    - 특정 용도에 쓰라고 별도로 떼어 놓은 메모리이다. 컴파일 시에 결정되는 것으로 너무 크게 잡을 수 없다. 그래서 큰 데이터를 처리해야 할 경우 스택 메모리에 넣지 못 한다.
- 힙 메모리
  - 컴퓨터에 존재하는 범용적 메모리
  - 스택 메모리처럼 특정 용도로 떼어 놓은 것이 아니다.
  - 스택과 달리 컴파일러 및 CPU가 자동으로 메모리 관리를 해주지 않는다. 따라서 프로그래머가 원하는 때에 원하는 만큼 메모리를 할당받아와 사용하고 원할 때 반납할 수 있다.
- 힙 메모리의 장점
  - 용량 제한이 없다. 컴퓨터에 남아있는 메모리만큼 사용이 가능하다.
  - 프로그래머가 데이터의 수명을 직접 제어할 수 있다. 스택에 저장되어 있는 변수처럼 함수 호출이 끝난다고 사라지지 않는다.
- 힙 메모리의 단점
  - 빌려온 메모리를 직접 해제하지 않으면 누구도 그 메모리를 쓸 수 없다.
  - 스택에 비해 할당/해제 속도가 느리다.
    - 스택은 오프셋 개념인데 반해 힙은 사용/비사용 중인 메모리 관리 개념이다.
    - 또한 메모리 공간에 구멍이 생겨 효율적으로 메모리 관리가 어렵기도 하다.
- 스택 메모리는 정적 메모리이다.
  - 이미 공간이 따로 잡혀 있다.
  - 할당/해제가 자동으로 관리되게 코드가 컴파일된다.
  - 오프셋 개념으로 정확히 몇 바이트씩 사용해야 하는지 컴파일 시 결정된다.
- 힙 메모리는 동적 메모리이다.
  - 실행 중에 크기와 할당/해제 시기가 결정된다.

## 동적 메모리

- 동적 메모리를 가져다 사용할 때는 총 세 가지 단계를 거친다.
  - 메모리 할당
    - 프로그램이 힙 관리자에게 메모리를 ~~ 바이트 달라고 요청한다.
  - 메모리 사용
    - 그 메모리를 원하는 대로 사용한다. 이 때까지 포인터 사용했던 것과 다르지 않다.
  - 메모리 해제
    - 프로그램이 힙 관리자에게 메모리를 반환한다.

## 메모리 할당 및 해제 함수, malloc()

## free(), malloc() 사용 예

## 동적 메모리 할당 시 문제

## free()는 몇 바이트를 해제할지 어떻게 알지?, calloc(), memset(), realloc()

## realloce()의 메모리 누수 문제, memcpy()

## memcmp(), 정적 vs 동적 메모리

## 동적 메모리의 소유권 문제

## 다중 포인터, 이중 포인터

## 다중 포인터를 쓰는 이유, 다중 포인터 예